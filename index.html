// ***************************************************
// الروابط المطلوبة للخلفيات:
// ***************************************************
const ORIGINAL_BACKGROUND = "url('https://image.pollinations.ai/prompt/floating,bitcoin,dollar,currencies,crypto,digital,money,dark,background?width=1024&height=1024&seed=2')";
const SPLASH_BACKGROUND = "url('https://image.pollinations.ai/prompt/abstract,cyber,currency,background,neon,glow?width=1024&height=1024&seed=22')";

// ***************************************************
// بيانات API والمخزن المؤقت (CACHE)
// ***************************************************
const API_KEY = '68667c547b32d00728aef432'; // مفتاح API الخاص بك
const BASE_URL = `https://v6.exchangerate-api.com/v6/${API_KEY}/latest/USD`;
const CACHE_DURATION_MS = 6 * 60 * 60 * 1000; // مدة التخزين المؤقت: 6 ساعات (للحفاظ على الحصة المجانية)

let liveExchangeRates = {}; // لتخزين الأسعار التي تم جلبها
let lastFetchTimestamp = 0; // لتخزين آخر وقت تم فيه الجلب

// ***************************************************
// العملات المدعومة
// ***************************************************
const supportedCurrencies = {
    'USD': 'دولار أمريكي (USD)', 'EUR': 'يورو (EUR)', 'GBP': 'جنيه استرليني (GBP)', 
    'JPY': 'ين ياباني (JPY)', 'CAD': 'دولار كندي (CAD)', 'RUB': 'روبل روسي (RUB)', 
    'ILS': 'شيكل إسرائيلي (ILS)', 'ARS': 'بيزو أرجنتيني (ARS)', 'BRL': 'ريال برازيلي (BRL)', 
    'SAR': 'ريال سعودي (SAR)', 'AED': 'درهم إماراتي (AED)', 'JOD': 'دينار أردني (JOD)', 
    'KWD': 'دينار كويتي (KWD)', 'BHD': 'دينار بحريني (BHD)', 'QAR': 'ريال قطري (QAR)', 
    'OMR': 'ريال عماني (OMR)', 'EGP': 'جنيه مصري (EGP)', 'LBP': 'ليرة لبنانية (LBP)', 
    'SYP': 'ليرة سورية (SYP)',
};

// ***************************************************
// دالة تشغيل التطبيق
// ***************************************************
function startApp() {
  document.body.style.backgroundImage = ORIGINAL_BACKGROUND;
  document.getElementById('splashScreen').classList.add('hidden');
  document.getElementById('mainApp').classList.remove('hidden');
  populateCurrencies(); // استدعاء جلب الأسعار وتعبئة القوائم
}

// ***************************************************
// 1. دوال عرض وتقليب التاريخ
// ***************************************************
let currentCalendarMode = 'gregorian'; 

function displayCurrentDates() {
  const dateDisplay = document.getElementById('dateDisplay');
  const today = new Date();

  const gregorianDate = new Intl.DateTimeFormat('ar-EG', { 
      weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
  }).format(today);

  const hijriDate = new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura', {
      weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
  }).format(today);
  
  let dateToShow;
  let buttonText;
  
  if (currentCalendarMode === 'gregorian') {
      dateToShow = gregorianDate + ' م';
      buttonText = 'عرض الهجري';
  } else {
      dateToShow = hijriDate + ' هـ';
      buttonText = 'عرض الميلادي';
  }

  dateDisplay.innerHTML = `
    <div style="font-size: 1.1em; color: #00FF99;">${dateToShow}</div>
    <button id="dateToggle" onclick="toggleCalendar()">${buttonText}</button>
  `;
}

function toggleCalendar() {
    currentCalendarMode = (currentCalendarMode === 'gregorian') ? 'hijri' : 'gregorian';
    displayCurrentDates(); 
}

// ***************************************************
// 2. قاموس الترجمة
// ***************************************************
const translations = {
    'ar': {
        'mainTitle': 'محول العملات الفوري (أسعار حية)',
        'placeholder_amount': 'أدخل المبلغ',
        'to_text': 'إلى',
        'button_convert': 'تحويل',
        'error_amount': 'الرجاء إدخال مبلغ صحيح وموجب.',
        'error_rate': 'عذراً، سعر صرف إحدى العملات غير متوفر.',
        'lang_arabic': 'العربية',
        'lang_english': 'English',
        'equals_text': 'يساوي'
    },
    'en': {
        'mainTitle': 'Instant Currency Converter (Live Rates)',
        'placeholder_amount': 'Enter Amount',
        'to_text': 'To',
        'button_convert': 'Convert',
        'error_amount': 'Please enter a valid, positive amount.',
        'error_rate': 'Sorry, the exchange rate for one of the currencies is unavailable.',
        'lang_arabic': 'العربية',
        'lang_english': 'English',
        'equals_text': 'Equals'
    }
};

// ***************************************************
// 3. دالة تبديل اللغة وتحديث الواجهة
// ***************************************************
function changeLanguage(lang) {
    const currentTranslation = translations[lang];
    if (!currentTranslation) return;

    document.getElementById('mainTitle').textContent = currentTranslation.mainTitle;
    document.getElementById('amount').placeholder = currentTranslation.placeholder_amount;
    document.getElementById('toText').textContent = currentTranslation.to_text;
    document.getElementById('convertButton').textContent = currentTranslation.button_convert;
    
    if (lang === 'ar') {
        document.body.dir = 'rtl';
    } else {
        document.body.dir = 'ltr';
    }
    
    document.getElementById('result').textContent = ''; 
}

// ***************************************************
// 4. دالة تبديل ظهور القائمة المنسدلة
// ***************************************************
function toggleMenu() {
    const menu = document.getElementById('languageMenu');
    menu.classList.toggle('show');
}

// ***************************************************
// 5. دالة تبديل العملات (Swap Currencies)
// ***************************************************
function swapCurrencies() {
    const fromSelect = document.getElementById('fromCurrency');
    const toSelect = document.getElementById('toCurrency');
    const tempValue = fromSelect.value;
    
    fromSelect.value = toSelect.value;
    toSelect.value = tempValue;
    
    convertCurrency(); 
}

// ***************************************************
// 6. دالة جلب الأسعار وتعبئة القوائم (مع التخزين المؤقت)
// ***************************************************
async function populateCurrencies() {
    const fromSelect = document.getElementById('fromCurrency');
    const toSelect = document.getElementById('toCurrency');
    const resultDiv = document.getElementById('result');
    const loadingMessage = document.getElementById('loadingMessage');
    
    loadingMessage.style.display = 'block';
    resultDiv.innerText = "";
    
    // التحقق من المخزن المؤقت
    const currentTime = Date.now();
    const timeSinceLastFetch = currentTime - lastFetchTimestamp;

    // إذا كانت البيانات موجودة وحديثة (ضمن مدة الكاش)، استخدمها مباشرة
    if (Object.keys(liveExchangeRates).length > 0 && timeSinceLastFetch < CACHE_DURATION_MS) {
        console.log("استخدام البيانات المخزنة (CACHE) لتوفير الحصة.");
        loadingMessage.style.display = 'none';
        fillCurrencySelectors(fromSelect, toSelect);
        convertCurrency();
        return;
    }
    
    // إذا كانت غير موجودة أو قديمة، قم بالجلب من API
    try {
        const response = await fetch(BASE_URL);
        const data = await response.json();

        if (data.result === 'success') {
            liveExchangeRates = data.conversion_rates;
            lastFetchTimestamp = currentTime; // تحديث وقت الجلب
            console.log("تم جلب وتحديث الأسعار بنجاح من API.");
            
            fillCurrencySelectors(fromSelect, toSelect);
            convertCurrency();

        } else {
            console.error("فشل جلب الأسعار من API. يرجى التحقق من المفتاح.");
            resultDiv.innerText = "عفواً، فشل جلب الأسعار المحدثة. (تحقق من المفتاح أو الحصة).";
        }
    } catch (error) {
        console.error("حدث خطأ في الاتصال بالـ API:", error);
        resultDiv.innerText = "تعذر الاتصال بخادم الأسعار. تحقق من اتصالك بالإنترنت.";
    } finally {
        loadingMessage.style.display = 'none';
    }
}

// دالة مساعدة لملء القوائم المنسدلة
function fillCurrencySelectors(fromSelect, toSelect) {
    fromSelect.innerHTML = '';
    toSelect.innerHTML = '';

    for (const code in supportedCurrencies) {
        if (liveExchangeRates.hasOwnProperty(code)) {
            const name = supportedCurrencies[code];
            
            const option = document.createElement('option');
            option.value = code;
            option.textContent = name;
            
            fromSelect.appendChild(option);
            toSelect.appendChild(option.cloneNode(true));
        }
    }
    fromSelect.value = 'USD'; 
    toSelect.value = 'SYP';
}

// ***************************************************
// 7. دالة التحويل باستخدام الأسعار الحية
// ***************************************************
function convertCurrency() {
    const amountInput = document.getElementById('amount');
    const from = document.getElementById('fromCurrency').value;
    const to = document.getElementById('toCurrency').value;
    const resultDiv = document.getElementById('result');
    const amount = parseFloat(amountInput.value);
    
    const currentLang = document.body.dir === 'rtl' ? 'ar' : 'en';
    const translation = translations[currentLang];

    if (Object.keys(liveExchangeRates).length === 0) {
        resultDiv.innerText = "الرجاء انتظار تحميل الأسعار من API.";
        return;
    }

    if (isNaN(amount) || amount <= 0) {
      resultDiv.innerText = translation.error_amount;
      return;
    }
    
    if (!liveExchangeRates.hasOwnProperty(from) || !liveExchangeRates.hasOwnProperty(to)) {
      resultDiv.innerText = translation.error_rate;
      return;
    }

    // حساب التحويل
    const fromRate = liveExchangeRates[from];
    const toRate = liveExchangeRates[to];
    
    // المعادلة
    // لتحويل من العملة (FROM) إلى الدولار (USD): Amount / fromRate (لأن الأسعار كلها بالنسبة للدولار)
    // لتحويل من الدولار (USD) إلى العملة (TO): (Amount / fromRate) * toRate
    
    const amountInUSD = amount / fromRate;
    const convertedAmount = amountInUSD * toRate;
    
    const fromName = supportedCurrencies[from];
    const toName = supportedCurrencies[to];
    
    // تنسيق النتيجة لتبدو احترافية (رقمين عشريين)
    const formattedAmount = convertedAmount.toFixed(2);

    resultDiv.innerHTML = `
        ${amount.toLocaleString(currentLang === 'ar' ? 'ar-EG' : 'en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} 
        <span style="color: #00FF99;">(${fromName})</span>
        <br> 
        ${translation.equals_text}: 
        <br>
        <span style="color: #FFD700; font-size: 1.2em;">${formattedAmount.toLocaleString(currentLang === 'ar' ? 'ar-EG' : 'en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
        <span style="color: #00FF99;">(${toName})</span>
    `;
}

// ***************************************************
// استدعاء الدوال عند تحميل الصفحة
// ***************************************************
document.addEventListener('DOMContentLoaded', () => {
    // إعداد الخلفية الأولية لشاشة الترحيب
    document.body.style.backgroundImage = SPLASH_BACKGROUND;
    
    // عرض التاريخ مباشرة
    displayCurrentDates(); 
    
    // إخفاء القائمة المنسدلة عند النقر خارجها
    document.addEventListener('click', function(event) {
        const menu = document.getElementById('languageMenu');
        const menuButton = document.getElementById('menuButton');
        if (!menu.contains(event.target) && !menuButton.contains(event.target)) {
            menu.classList.remove('show');
        }
    });
});
      
